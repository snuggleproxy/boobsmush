<html onmousemove="m(event)">
	<head>
	<script>

        function Ob(mom){
            ob = document.createElement("canvas");
            ob.style.position = 'absolute';
            ob.x = x;
            ob.y = y;
            ob.rejig = function(){
                this.style.left = this.x;
                this.style.top = this.y;
            };
            ob.rejig();
            ob.style.border='dashed';
            ob.ctx=ob.getContext('2d');
            if(mom){// there should only be one object without a mom.
                ob.mom = mom;
                mom.babbs.push(ob);
            }
            ob.zones = [];
            ob.trigs = [];
            ob.babbs = [];
            ob.move = function(xchange,ychange){
                this.x += xchange;
                this.y += ychange;
                this.rejig();
                for (i=0;i<this.babbs.length;i++){
                    this.babbs[i].move(xchange,ychange);
                }
            };

            //ob.beginPath();
            //ob.rect(0, 0, canvas.width, canvas.height);
            //ob.fillStyle = 'yellow';
            //ob.fill();
            window.selected_ob = ob;
            document.body.appendChild(ob);    
            return(ob)
        }
        // uhh, shouldn't some of this be in init? do we even need init? How does loading werk?
        pencil_down = false;
        // it goes [0] is onclick and [1] is on move while clickd!!!
            // no I don't know if this makes sense!
        window.input_fun={
            'movin_menu':[
                function(e){
                },
                function(e){
                    menu.style.left=parseInt(menu.style.left)+dx;
                    menu.style.top=parseInt(menu.style.top)+dy;
                },],
            'move':[
                function(e){
                    // move center to cursor
                    //selected_ob.style.left = x-testob.width/2;
                    //selected_ob.style.top = y-testob.height/2;
                },
                function(e){
                    // move by dx & dy
                    selected_ob.move(dx,dy);
                },],
            'draw':[
                function(e){
                },
                function(e){
                    drwrlineee(selected_ob,lastx,lasty,x,y);
                },],
            'new':[
                function(e){
                    newob = Ob(selected_ob);
                },
                function(e){
                },],
        }
        window.onmousedown=function(e){
            toolz = ['move','draw','new'];
            menux=parseInt(menu.style.left);
            menuy=parseInt(menu.style.top);
            if(x>menux && x<menux+menu.width){
                if(y>menuy){
                    if(y< menuy+10){
                        pencil_down=true;
                        last_input_mode = input_mode;
                        input_mode = 'movin_menu';
                    }else{
                        for(i=toolz.length-1;i>=0;i--){
                            if(y<menuy+(i+1)*40){ //TODO: probz don't hardcode this
                                input_mode = toolz[i]
                                menuhl.y.baseVal.value=5+i*40;
                            }
                        }
                    }
                }
                console.log(input_mode);
            }else{
                pencil_down=true;
                input_fun[input_mode][0](e);
            }
        }
        window.onmouseup=function(e){
            pencil_down = false;
            if(input_mode=='movin_menu'){
                input_mode=last_input_mode;
            }
                //drwrlineee(canvas,lastx,lasty,firstx,firsty);//TODO:make this get the obj it needs or not, cause just pencil tool.
        }
        ////////////////
        // init function
        ////////////////
        window.onload=function(){

            // fuck the canvas right up fukkkkkkk uuuuuuuuu
            var w = window.innerWidth;
            var h = window.innerHeight;
            var canvas = document.getElementById('canvas');
            canvas.style.position = 'absolute';
            canvas.style.left = '0px';
            canvas.style.top = '0px';

            // custom cursorz r coool!
            document.body.style.cursor = "crosshair"

            window.menu = document.createElement("img");
            menu.style.position = 'absolute';
            menu.style.left=10;
            menu.style.top =10;
            menu.src = "toolbar2.png";
            menu.onmousedown=function(e){e.preventDefault()};
            document.body.appendChild(menu);
            window.input_mode = 'move';

            fuck_you=10;
            canvas.width=window.innerWidth-fuck_you;
            canvas.height=window.innerHeight-fuck_you;
            window.ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'red';
            ctx.fill();
            drwrlineee(canvas,51,51,300,80);
            window.x=100;
            window.y=100;
            window.dx=0;
            window.dy=0;
            window.lastx=0;
            window.lasty=0;

            testob = Ob();
            window.ctx = testob.ctx;

            window.svglayer = document.getElementById("svglayer");
            window.menuhl = document.getElementById("menuhl");
            menuhl.x.baseVal.value=5;
            menuhl.y.baseVal.value=5;
        }
        function drwrlineee(ob,x1,y1,x2,y2){
            ctxxx = ob.getContext('2d');
            ctxxx.beginPath();
            ctxxx.moveTo(x1-ob.style.left.slice(0,-2),y1-ob.style.top.slice(0,-2));
            ctxxx.lineTo(x2-ob.style.left.slice(0,-2),y2-ob.style.top.slice(0,-2));
            ctxxx.stroke();
        }
        // this is neat... delete it!!!!!
        function move(){
              bx = document.getElementById("box");

              hereXstr = bx.style.left;//.slice(0,bx.style.left.length-2);
              hereXstr.replace("px","");
              hereX = parseInt(hereXstr);

              hereYstr = bx.style.top;
              hereYstr.replace("px","");
              hereY = parseInt(hereYstr);

              thereX = x;
              thereY = y;

              newX = (4*hereX+thereX)/5;
              newY = (4*hereY+thereY)/5;
	      	  bx.style.left = newX;
	      	  bx.style.top = newY;

              if(Math.abs(thereX-hereX)>7 || Math.abs(thereY-hereY)>7)
                  doing = 1;
                  //setTimeout(function(){move(x,y);}, 100);
        }
		function m(e){
            lastx = x;
            lasty = y;
            x = e.pageX;
            y = e.pageY;
            dx = x-lastx;
            dy = y-lasty;
            if(pencil_down){
                input_fun[input_mode][1](e);
            }
		}
	</script>
	</head>
	<body>
        <canvas id="canvas"></canvas>
        <svg id="svglayer" width="400" height="1000" style="position:absolute">
          <rect id="menuhl" x=100 y=100 width="38" height="38" style="fill:rgb(2550,100,100);stroke-width:4;stroke:rgb(0,0,0)" />
        </svg>
	</body>
</html>
